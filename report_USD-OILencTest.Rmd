---
title: "Зависимость курса USD/RUB от цены на нефть марки Brent"
author: "Alexander Cherkashin"
date: "9 декабря 2015 г."
lang: russian
output: pdf_document
---
 
```{r setup, cache=FALSE, include=FALSE}
library(knitr);library(quantmod); library(ggplot2); library(Rmisc); library(scales);library(RCurl);library(tidyr)
opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, download.file.method="wb")
```
 
```{r getting data, cache=TRUE, include=FALSE}
getSymbols("DCOILBRENTEU", src = "FRED", method="libcurl"); getSymbols("RUB=X", src = "yahoo", method="libcurl")
DCOILBRENTEU <- na.locf(DCOILBRENTEU)
dat <- cbind(`RUB=X`[,"RUB=X.Close"], DCOILBRENTEU)
dat <- dat['2007-01-01/']; colnames(dat) <- c("USDrate", "oilPrice")
 
dat <- zoo::na.locf.default(dat, xout = seq(start(dat), end(dat), "day"))
cbInterventions<-read.csv2("ОперацииЦБнаВалютномРынке.csv", col.names = c("date", "value"), colClasses = c("character", "numeric"), na.strings = 0)
cbInterventions$date <- as.Date(cbInterventions$date, format = "%d.%m.%Y")
```
 
```{r modelling, cache=TRUE}
doLm <- function(x) {
        lmod <- lm(USDrate ~ oilPrice, data = as.data.frame(x))
        c(coef(lmod), "r.squared" = summary(lmod)$r.squared)
}
doLmLog <- function(x) {
        lmod <- lm(USDrate ~ log(oilPrice), data = as.data.frame(x))
        c(coef(lmod), "r.squared" = summary(lmod)$r.squared)
}
 
oilDep <- rollapplyr(dat, 365, doLm, fill = NA, by.column = FALSE)
oilDepLog <- rollapplyr(dat, 365, doLmLog, fill = NA, by.column = FALSE)
dat <- cbind(dat, oilDep, oilDepLog)
dat <- as.data.frame(dat)
dat$date <- as.Date(rownames(dat))
colnames(dat)[3:8] <- c("intercept", "slope", "r.squared", "interceptLog", "slopeLog", "r.squaredLog")
```
 
## Исследование зависимости
 
Для начала необходимо определить характер влияния стоимости нефти на курс доллара.
 
На графике ниже, в верхней его части, представлена динамика курса доллара в рублях[^usd] и стоимости барреля нефти[^oil] марки Brent в долларах за период с 2007 года по настоящее время. Соответственно, для графика стоимости нефти ость X отражает стоимость в долларах, а для графика курса доллара - его стоимость (курс) в рублях. Темными вертикальными линиями отмечены дата существенных изменений в [политике ЦБ по регулированию курса](http://www.cbr.ru/dkp/?PrtId=e-r_policy) рубля относительно других валют.
 
Нижний график привден справочно, показывает дневные объемы интервенций ЦБ РФ на валютном рынке[^interventions]. "+" - покупка валюты, "-" - продажа валюты. Данные доступны только с конца 2013 года.
 
По верхнему графику можно отметить, что между курсом доллара и ценой на нефть существует некая обратно пропорциональная зависимость. Например, в период с 2007 года по середину 2008 цена на нефть растет, а курс доллара падает. Далее, ближе к началу 2009 года нефть падает, а доллар растет. Аналогичную картину можно наблюдать и в других периодах.
 
Что еще можно заметить, так это то что в разные периоды изменения имеют разную динамику: в начале графика движения курса доллара, связанные с движением стоимости нефти гораздо менее резкие чем в конце. То есть сила колебаний курса доллара при более-менее одинаковых движениях в цене нефти меняется со временем, в общем даже можно сказать, что она растет.
 
```{r first plot all data, cache=FALSE, fig.height=8}
 
 
cols1 <- c("Цена нефти, долл."="black","Цена доллара, руб."="darkgreen")
p1 <-qplot(y=dat$oilPrice, x=dat$date, colour="Цена нефти, долл.", geom = "line", size=I(1)) +
        scale_x_date(breaks = date_breaks("year"), labels = date_format("%Y")) +
        xlab("")+ylab("")+ geom_line(aes(y=dat$USDrate, colour="Цена доллара, руб."), size=1) +
        scale_colour_manual(name="",values=cols1) + ggtitle("Динамика стоимости Brent USD/баррель и курса USD/RUB") +
        theme(legend.position="top") +
        geom_vline(xintercept = c(as.integer(as.Date("2014-11-01")),
                                  as.integer(as.Date("2014-08-01")),
                                  as.integer(as.Date("2012-08-01")),
                                  as.integer(as.Date("2010-10-01")),
                                  as.integer(as.Date("2009-02-01")),
                                  as.integer(as.Date("2007-02-01"))), colour = "gray30")
 
p3 <- ggplot(aes(y=cbInterventions$value,
                 x=cbInterventions$date,
                 fill=factor(sign(cbInterventions$value), levels = c("-1","1"), labels = c("продажа", "покупка"))),
                 data = cbInterventions) +
        scale_x_date(limits=c(min(dat$date), max(dat$date)), breaks = date_breaks("year"), labels = date_format("%Y")) +
        scale_fill_manual(name="",values=c("покупка"="red", "продажа"="blue", "0"="gray")) +
        geom_bar(stat="identity", position = "identity") + ylim(c(-11500, 300)) +
        ggtitle("Объем интервенций ЦБ млн.USD") +
        theme(legend.position="top") + ylab("") + xlab("") +
        geom_vline(xintercept = c(as.integer(as.Date("2014-11-01")),
                                  as.integer(as.Date("2014-08-01")),
                                  as.integer(as.Date("2012-08-01")),
                                  as.integer(as.Date("2010-10-01")),
                                  as.integer(as.Date("2009-02-01")),
                                  as.integer(as.Date("2007-02-01"))), colour = "gray30")
 
multiplot(p1,p3)
 
 
```
 
Это сильное свидетельство в пользу предположения, что характер зависимости кусра доллара от стоимости нефти меняется со временем. А значит модель, хорошо объясняющая зависимость, например, в 2008 году, скорее всего, будет плохо работать в 2015. Отсюда же следует что модель построенная на полном наборе данных тоже должна быть менее точной модели построенной на данных, ограниченных более поздним периодом. В модели, построенной на полных данных, старые данные, со старой, отличающейся от сегодняшней зависимостью, будут систематически *смещать* оценку зависимости курса.
 
Таким образом разумно для описания сегодняшней зависимости брать только последние данные, но какой именно период брать? Очевидно, что данные за один день не дадут нам представления о характере влияния нефти на доллар[^1].
 
Неделя  - семь точек - кажется, тоже недостаточный период для того что бы *поймать* характер зависимости. В общем случае, т.к. мы не можем судить о том, с какой периодичностью меняется характер зависимости, и, более того, можем предположить, что никакой строгой периодичности в таких изменениях нет, выбор "окна" - периода по которому строить модель, достаточно произволен.
 
Чем меньше точек мы возьмем к сегодняшнему моменту - тем выше шанс, что на нашу модель не будет влиять уже неактуальная зависимость и тем быстрее мы будем "ловить" изменения в этой зависимости. С другой стороны - чем больше точек, тем больше данных и тем точнее и увереннее мы можем судить о характере зависимости.
 
С моей точки зрения это проявление широко известного конфликта в статистическом моделировании: [Bias–variance tradeoff](https://en.wikipedia.org/wiki/Bias%E2%80%93variance_tradeoff). Его можно охарактеризовать как компромисс между ошибкой из-за систематического смещения в оценке (в данном случае из-за "устаревших" данных) и ошибкой в следствии статистической "неуверенности" из-за слишком малого количества данных.
 
Здесь я предлагаю для моделирования брать период длинною в год, а точнее в 365 дней. Аргументом в пользу такого периода является то, что в случае если и существует какая-то сезонность в изменениях курсов, она будет учитываться. Тем не менее, можно пробовать брать разные периоды, например 30 или 90 дней.
 
Попробуем изучить изменение зависимости нефть-доллар во времени. В каждой точке, т.е. каждый день, мы можем брать его и 364 предшествующих ему дня, и строить по такому скользящему году модель[^2]. После чего сдвигать это "окно" на один день вправо и строить модель снова. Таким образом, для каждой точки, за исключением первых 364 мы можем построить модель которая будет включать данные за скользящий год.
 
На графике ниже коричневая линия отражает показатель r^2^[^3] для каждой модели. Его можно описать как процент, на который изменения курса доллара  объясняются изменениями цены на нефть. 1 - означает 100% зависимость, 0 - отсутствие какой-либо зависимости.
 
```{r r-squared plot}
myCor <- function(x) {
        cor(x[,1], x[,2])
}
cors <- rollapplyr(dat[,1:2], 365, myCor, fill = NA, by.column = FALSE)
oilSD <- rollapplyr(dat[,"oilPrice"], 365, sd, fill = NA, by.column = FALSE)
 
cols2 <- c("r^2"="chocolate","SD Цены на нефть в % от макс.SD \n (величина колебаний цены)"="#3591d1",
           "Корреляция \n за предшествующий скользящий год"="black")
p2 <-qplot(y=dat$r.squaredLog, x=dat$date, colour="r^2", geom = "line", size=I(1.5)) + scale_x_date(breaks = date_breaks("year"), labels = date_format("%Y")) + ggtitle("Показатели корреляции и движения цены на нефть за скользящие года") +
        xlab("")+ylab("")+ scale_colour_manual(name="",values=cols2) +
        theme(legend.position="top") +
        geom_line(aes(y=oilSD/max(oilSD, na.rm = TRUE), colour="SD Цены на нефть в % от макс.SD \n (величина колебаний цены)"), size=1) +
        geom_line(aes(y=cors, colour="Корреляция \n за предшествующий скользящий год"), size=1) +
        geom_vline(xintercept = c(as.integer(as.Date("2014-11-01")),
                                  as.integer(as.Date("2014-08-01")),
                                  as.integer(as.Date("2012-08-01")),
                                  as.integer(as.Date("2010-10-01")),
                                  as.integer(as.Date("2009-02-01")),
                                  as.integer(as.Date("2007-02-01"))), colour = "gray30")
p2
```
 
Мы видим, что величина зависимости сильно колеблется практически от нуля до единицы. То есть периоды когда зависимость достигает максимума, а есть - где она практически не выделяется. Конечно, учитывая вышесказанное предположение о том что характер зависимости меняется со временем, а особенно если предположить что бывают ситуации радикальных изменений, например, когда противоположное движение показателей сменяется однонаправленным, наш скользящий год может поймать "хвосты" двух противоположных (прямо пропорциональной и обратно пропорциональной) зависимостей, из-за которых модель покажет околонулевое значение r^2^. Тем не менее, кажется, что зависимость курса доллара в рублях и цены на нефть в долларах должна всегда иметь обратный характер: цена на нефть расчет - курс доллара падает, и наоборот. Судя по верхнему графику, похоже что обычно так оно и есть. Тем не менее, ниже мы увидим что был как минимум один момент когда несмотря на рост нефти так же рос курс доллара.
 
Когда коричневая кривая растет это значит что курс доллара все лучше и лучше согласуется с ценой на нефть, и предшествующий тренд все более подтверждается новыми данными. Когда кривая падает это говорит либо о том, что на курс доллара все более начинают влиять факторы не связанные с ценой на нефть либо о том что происходит изменение характера зависимости. Впрочем, если характер не меняется кардинально (когда меняется направление: знак зависимости), этот показатель не должен опускаться до нуля. И около нулевые значения все-таки означают что конкретно в эти 365 дней выраженной зависимости не наблюдалось.
 
Синяя линия - стандартное отклонение цены на нефть за скользящий год. Она характеризует насколько сильно менялась цена на нефть за предшествующие 365 дней. Можно заметить, что пики двух кривых более-менее совпадаю, отсюда можно сделать что влияние стоимости нефти на курс доллара становится более выраженным в случаях более сильных изменений стоимости нефти. Когда стоимость нефти изменяется слабо, зависимость курса доллара от нее падает. Судя по всему, влияние других факторов становится более значимым.
 
Это можно объяснить существовавшим валютным коридором: ЦБ РФ нивелировал относительно слабые колебания курса с помощью валютных интервенций, а в случае сильных изменений плавно двигал валютный коридор.
 
"С 10 ноября 2014 года Банк России упразднил действовавший ранее механизм курсовой политики, отменив интервал допустимых значений стоимости бивалютной корзины и регулярные интервенции на границах указанного интервала и за его пределами. При этом, новый подход Банка России к проведению операций на внутреннем рынке не предполагает полного отказа от валютных интервенций, их проведение возможно в случае возникновения угроз для финансовой стабильности." - [ЦБ РФ](http://www.cbr.ru/dkp/?PrtId=e-r_policy)
 
На самом деле фактическая отмена валютного коридора произошла чуть ранее: "С 18 августа 2014 года Банк России установил объем интервенций, направленных на сглаживание колебаний курса рубля, во внутренних диапазонах плавающего операционного интервала равным 0 долларов США."
 
Две эти даты отмечены последними вертикальными линиями на графиках.
 
По идее это должно привести к тому что доллар будет реагировать на нефть острее. В принципе, мы можем это наблюдать: в конце 2008 года цена на нефть упала еще сильнее, чем сегодня, но влияние на курс было не таким значительным. Так же, представляется, доллар в отсутствие регулярных интервенций теперь должен лучше "отрабатывать" незначительные колебания цены на нефть[^smallmoves], которые раньше сглаживались валютным коридором.
 
Черная линия - величина корреляции курса доллара и цены на нефть. Мы видим, что ее значения, в основном, лежат в отрицательной области, а значит зависимость действительно обратная. Интересный пик графика корреляции находится в районе 1кв. 2014 года, точнее, он приходится на дату: 17 марта 2014г. Корреляция заходит в область положительных значений, а значит, зависимость на короткий отрезок времени становится прямой: нефть растет, и курс растет!
 
Похоже, низкая корреляция вокруг этого пика объясняется тем, что наш скользящий год захватывает части разных зависимостей: прямой и обратной, они нивелируют друг друга в течении этого период и корреляция становится близкой к нулю.
 
Рассмотрим этот период (скользящий год с 18 марта 2013 по 17 марта 2014) подробнее на графике ниже:
 
```{r plot strange interventions, cache=FALSE, fig.height=8}
dat1Year <- dat[dat$date > as.Date("2013-03-17") & dat$date <= as.Date("2014-03-17"),]
cols1 <- c("Цена нефти, долл."="black","Цена доллара, руб."="darkgreen")
p1 <-qplot(y=dat1Year$oilPrice, x=dat1Year$date, colour="Цена нефти, долл.", geom = "line", size=I(1)) +
        scale_x_date(limits=c(min(dat1Year$date), max(dat1Year$date)), breaks = date_breaks("year"), labels = date_format("%Y")) +
        xlab("")+ylab("")+ geom_line(aes(y=dat1Year$USDrate, colour="Цена доллара, руб."), size=1) +
        scale_colour_manual(name="",values=cols1) + ggtitle("Динамика стоимости Brent USD/баррель и курса USD/RUB") +
        theme(legend.position="top") +
        geom_vline(xintercept = c(as.integer(as.Date("2014-11-01")),
                                  as.integer(as.Date("2014-08-01")),
                                  as.integer(as.Date("2012-08-01")),
                                  as.integer(as.Date("2010-10-01")),
                                  as.integer(as.Date("2009-02-01")),
                                  as.integer(as.Date("2007-02-01"))), colour = "gray30")
 
p3 <- ggplot(aes(y=cbInterventions$value,
                 x=cbInterventions$date,
                 fill=factor(sign(cbInterventions$value), levels = c("-1","1"), labels = c("продажа валюты", "покупка валюты"))),
                 data = cbInterventions) +
        scale_x_date(limits=c(min(dat1Year$date), max(dat1Year$date)), breaks = date_breaks("year"), labels = date_format("%Y")) +
        scale_fill_manual(name="",values=c("покупка валюты"="red", "продажа валюты"="blue", "0"="gray")) +
        geom_bar(stat="identity", position = "identity") + ylim(c(-11500, 300)) +
        ggtitle("Объем интервенций ЦБ млн.USD") +
        theme(legend.position="top") + ylab("") + xlab("") +
        geom_vline(xintercept = c(as.integer(as.Date("2014-11-01")),
                                  as.integer(as.Date("2014-08-01")),
                                  as.integer(as.Date("2012-08-01")),
                                  as.integer(as.Date("2010-10-01")),
                                  as.integer(as.Date("2009-02-01")),
                                  as.integer(as.Date("2007-02-01"))), colour = "gray30")
multiplot(p1,p3)
```
 
Можно наблюдать что в этот период растет как цена нефти, так и курса доллара. Особенно интересно, что ЦБ ближе к концу начинает осуществляет масштабные продажи валюты, но, несмотря на это и на рост нефти курс доллара продолжает расти! На графике за полный период выше видно, что после интервенций курс ненадолго снижается, к сожалению лишь за тем что бы резко вырасти вслед за масштабным падением цены на нефть.
 
Посмотрим на график зависимости курса доллара от стоимости нефти в этот период:
 
```{r USD-Oil plot, cache=FALSE}
quarter <- factor(paste(quarters(dat1Year$date),format(dat1Year$date, "%y")), levels = c("Q1 13","Q2 13","Q3 13","Q4 13","Q1 14"))
qplot(y=dat1Year$USDrate, x=dat1Year$oilPrice, colour=quarter, size=I(4))+theme(legend.position="top") +
        xlab("Стоимость нефти, долл.")+ylab("Курс доллара, руб.")+scale_colour_discrete(name = "Квартал")
```
 
Цвет точек отражает квартал интересующего нас периода. Мы можем наблюдать в первый и второй кварталы 2013 года обычную, хоть и не слишком четко выраженную, обратную зависимость: дороже нефть - ниже курс. Но в следующие два квартала зависимость неожиданно меняется на противоположную[^noimpact]. Первый квартал 2014 года вообще не говорит о наличии какой-либо зависимости: курс просто растет при не меняющейся цене на нефть.
 
можно увидеть в первый квартал 2013 и первый квартал 2014 года цена на нефть приблизительно находится в одном диапазоне, а курс просто вырос на 5 рублей. При том, что именно на первый квартал 2014 приходятся продажи валюты ЦБ. Т.е. курс вырос, несмотря на два сильных давящих фактора.
 
Это свидетельство того, что могут быть ситуации, когда не только нефть (и давление ЦБ) влияет на курс. Причины такого аномального роста подлежат дополнительному исследованию. Мы должны с осторожностью говорить об обратной зависимости курса доллара и нефти, она, безусловно, в общем, существует, но локально может и не выполнятся: мы это видели на протяжении трех кварталов.
 
Как же вообще менялась зависимость курса доллара и нефти на протяжении этих лет? График ниже, в целом, повторяет предыдущий, только цветом выделяются года. Точки отмечены цифрами, отражающими номер года.
```{r years plot}
ggplot(data = dat, aes(y = as.numeric(dat[, "USDrate"]),
                       x = as.numeric(dat[, "oilPrice"]),
                       color = format(dat$date, "%Y"))) +
        geom_text(aes(label = ifelse(substr(format(dat$date, "%y"),1,1)=="0",substr(format(dat$date, "%y"),2,2), substr(format(dat$date, "%y"),1,2)))
                  , alpha = 1)+
        scale_colour_brewer(palette="Set1", name = "Год")+xlab("Стоимость нефти, долл.")+ylab("Курс доллара, руб.") +
        stat_smooth(method = "lm", se=FALSE, size=1)+theme(legend.position="top")
```
 
Скользя взглядом по графику снизу вверх, от 7,8 до 15 года мы видим что курс доллара, в общем, растет из года в год, несмотря на нефть. В каждый календарный год вписан простая линейная зависимость[^linearTrend]. Помимо общего роста курса прямая - линейная зависимость - все круче, угол ее наклона все больше. То есть изменение цены на нефть на 1 доллар с каждым годом все сильнее отражается на курсе доллара.
 
## Прогнозирование
 
Я бы хотел обосновать точку зрения, в соответствии с которой прогнозирование курса доллара, основываясь на представлениях о цене на нефть в будущем представляется затруднительным.
 
Ошибка в прогнозе курса в таком случае будет состоять из следующих компонентов:
 - во-первых, ошибка прогноза стоимости нефти;
 - во-вторых, ошибка самой модели[^modelError], основанной на стоимости нефти;
- и в-третьих, неустранимой ошибки при любом моделировании: "белого шума" в реальных значениях курса.
 
Раскроем первые две составляющие подробнее.
 
Цена на нефть имеет рыночную природу. И, похоже, что на нее влияет гораздо больше факторов, чем на тот же курс, который, тоже устанавливается рынком, но который во многом, как мы показали, зависит от цены на нефть. Несмотря на эту зависимость, из-за природы цены на нефть она навряд ли сможет нам помочь в вопросе прогнозирования курса.
 
Но и сама эта зависимость непостоянна, мы видим что она меняется со временем, и, порой, меняется очень сильно. Перед нами встает вопрос, насколько глубоко в историю смотреть для определения *сегодняшней* зависимости. Конечно, мы можем брать в расчет всего несколько предстоящих дней, но тогда если, допустим, по какой либо случайности в последний день курс существенно отклонится *действительно* существующего тренда, эта точка "потянет" ошибочно потянет за собой весь тренд.
 
Помимо вышеуказанных проблем, даже если мы выберем наилучшее количество предшествующих точек, мы не можем быть уверены, что завтра характер зависимости курса от нефти не изменится.
 
К описанию сложности прогнозирования курса можно подойти с другой стороны: если бы кто-то нашел хороший способ прогнозировать курс доллара, он непременно постарался бы этим воспользоваться. Учитывая рыночную природу курса доллара действия этого агента на рынке свели бы эту зависимость на нет[^money]. Покупая и продавая валюту на пиках падения и роста, имея достаточно ресурсов, этот агент создавал бы спрос и предложение, которые двигали бы цену в противоположную сторону, выравнивая тренд. Таким образом, невероятным представляется даже стабильно успешно предсказывать хотя бы направление движения курса.
 
Тем не менее, судя по последнему графику, можно сказать что рубль, независимо от цен на нефть, имел тенденцию дешеветь. Если грубо оценить, то при похожих ценах на нефть в 2007 и 2015 годах рубль подешевел в 2 раза (за 9 лет это в среднем по 8% в год). Если рассматривать рубль как валюту, за которую можно приобрести продукцию РФ, а доллар - продукцию США, то эти 8% в год могут отражать разницу в инфляции в РФ и США[^inflation].
 
Попробуем представить хоть какой-то прогноз при базовых уровнях цены на нефть марки Brent в 20, 40 и 60 долларов США. Модель будем строить на последних 90 днях. Брать год кажется не логичным учитывая, что недавно произошли существенные изменения в регулировании курса Центральным Банком.
 
```{r forecast plot}
datLast730 <- tail(dat, 730)
datForecast <- expand.grid(oilPrice20 = 20, oilPrice40 = 40, oilPrice60 = 60, oilPrice100 = 100,
                           date = seq.Date(tail(datLast730$date,1)+1, tail(datLast730$date,1)+365, 1))
 
form <- as.formula("USDrate ~ log(oilPrice)")
wnd = 90
oil20 <- predict(lm(form, data = tail(datLast730, wnd)), data.frame(oilPrice=datForecast$oilPrice20), interval = "prediction")
oil40 <- predict(lm(form, data = tail(datLast730, wnd)), data.frame(oilPrice=datForecast$oilPrice40), interval = "prediction")
oil60 <- predict(lm(form, data = tail(datLast730, wnd)), data.frame(oilPrice=datForecast$oilPrice60), interval = "prediction")
oil100 <- predict(lm(form, data = tail(datLast730, wnd)), data.frame(oilPrice=datForecast$oilPrice100), interval = "prediction")
 
cols3 <- c("Цена доллара - Факт, руб."="darkgreen", "Brent 20/$" = "steelblue4", "steelblue3" = "blue", "Brent 40/$" = "slategray3",
           "Brent 60/$" = "firebrick1", "Brent 100/$" = "firebrick4", "Цена нефти, долл." = "black")
l <- nrow(datLast730)
p6 <- qplot(y=datLast730$USDrate, x=datLast730$date, colour="Цена доллара - Факт, руб.", geom = "line") +
        scale_x_date(breaks = date_breaks("year"), labels = date_format("%Y")) +
        xlab("")+ylab("") +
        
        geom_line(aes(y=oil20[,"fit"], x=datForecast$date, colour="Brent 20/$"), size=1) +
        geom_ribbon(aes(ymin=oil20[,"lwr"], ymax=oil20[,"upr"], x=datForecast$date), inherit.aes = FALSE, fill="steelblue4", alpha=0.3, show_guide=FALSE) +
       
        geom_line(aes(y=oil40[,"fit"], x=datForecast$date, colour="Brent 40/$"), size=1) +
        geom_ribbon(aes(ymin=oil40[,"lwr"], ymax=oil40[,"upr"], x=datForecast$date), inherit.aes = FALSE, fill="slategray3", alpha=0.3, show_guide=FALSE) +
       
        geom_line(aes(y=oil60[,"fit"], x=datForecast$date, colour="Brent 60/$"), size=1) +
        geom_ribbon(aes(ymin=oil60[,"lwr"], ymax=oil60[,"upr"], x=datForecast$date), inherit.aes = FALSE, fill="firebrick2", alpha=0.3, show_guide=FALSE) +
       
        geom_line(aes(y=oil100[,"fit"], x=datForecast$date, colour="Brent 100/$"), size=1) +
        geom_ribbon(aes(ymin=oil100[,"lwr"], ymax=oil100[,"upr"], x=datForecast$date), inherit.aes = FALSE, fill="firebrick4", alpha=0.3, show_guide=FALSE) +
        #geom_line(aes(y=datLast730$oilPrice, x=datLast730$date, colour="Цена нефти, долл.")) +
        
        scale_colour_manual(name="",values=cols3) +
        theme(legend.position="top") + ggtitle("Курс доллара в рублях при базовых ценах на нефть")
p6
```
 
Закрашенная область показывает интервал 95% уверенности, в котором должен находиться курс доллара при указанной цене на нефть[^interval].
 
Интервалы достаточно широкие, впрочем, видно, что даже если нефть вернется на прежние уровни к 100 долларам за баррель, курс уже не должен опустится сильно ниже 50 рублей. С другой стороны, при апокалиптическом сценарии падения нефти до 20 долларов, кажется, курс не будет сильно выше 80 рублей.
 
```{r why so wide}
wnd=550
Mwnd=365
datWnd <- tail(dat, wnd)
p7 <- ggplot(data = datWnd, aes(y = USDrate, x = oilPrice, colour = as.numeric(date)+1-min(as.numeric(date))))+
        geom_point(size=5)+
        scale_colour_gradient(low = "yellow", high = "black")+xlab("Стоимость нефти, долл.")+ylab("Курс доллара, руб.") +
        theme(legend.position="top")+scale_x_continuous(breaks=seq(20,120,10))+scale_y_continuous(breaks=seq(30,105,10))
 
doLmLog2 <- function(x) {
        lmod <- lm(USDrate ~ log(oilPrice), data = as.data.frame(x))
        predict(lmod, data.frame(oilPrice=20:120))
}
models <- rollapplyr(datWnd[,1:2], Mwnd, doLmLog2, fill = NA, by.column = FALSE)
models <- t(models) 
models <- models[,Mwnd:wnd]
models <- gather(as.data.frame(models))
models<-cbind(oilPrice = rep(20:120,wnd-Mwnd+1), models)
colnames(models) <- c("oilPrice", "model", "fittedRate")

p7+geom_line(data = models, aes(x=oilPrice, y=fittedRate, colour=as.numeric(factor(model))*2, group=model), size=0.2, alpha=1)
```
 
В принципе, можно заложить в прогноз удешевление рубля относительно доллара, аналогичное наблюдаемому в предыдущие годы - около 8% в среднем. Но для этого, неплохо бы лучше изучить его характер и причины. Ведь были годы, когда оно практически не проявлялось и годы резкого падения стоимости рубля.
 
## Прогнозирование курса на основе его последнего значения
 
Рассмотрим возможности "наивного" способа прогнозирования курса доллара на следующий месяц. Это способ при котором, например, плановый курс на следующий месяц устанавливается равным последнему известному фактическому курсу.
 
Фактический курс месяца M определим как средний курс ЦБ за все дни этого месяца.
 
Плановые курсы месяца М будем устанавливать равными фактическим курсам на 1-ое, 2-ое, ..., 15-ое числа месяца M-1 (месяца, предшествующего М).
 
Установим таким образом курсы для 35 месяцев в периоды с января 2013 по ноябрь 2015. В качестве ошибки планирования будем использовать среднюю ошибку отклонений плановых курсов от фактических за эти 35 месяцев.
 
В качестве бенчмарка будем использовать плановые курсы, установленные в нашей компании за эти месяцы и их среднее отклонение от фактических курсов. Для корректного сравнения, по возможности, были взяты курсы без корректировок. Эти курсы обычно устанавливаюся в первый день месяца M-1 (предшесвующего планируемому), либо в последний день месяца М-2 (за два месяца до планируемого).
 
На графике ниже изображены значения курсов доллара за 35 месяцев с начала 2013 года. Черная линия я с точками - фактические среднемесячные курсы, зеленая линия - установленые плановые курсы без корректировок за соответствующие месяца, градиентом от светло-серого до черного изображены плановые курсы, как зафиксированные курсы ЦБ на даты с 1 по 15 предыдущего месяца; самая светлая линия - на 1, самая темная - на 15.
 
```{r naive rates}
library(openxlsx)
rates <- read.xlsx("Rates.xlsx", sheet = 1)
ratesErrors <- rates
ratesErrors[,3:18] <- ratesErrors[,3:18] - ratesErrors[,2]
rmse <- sapply(ratesErrors[,3:18], function(x) sqrt(mean(x^2)))
mae <- sapply(ratesErrors[,3:18], function(x) mean(abs(x)))
 
cols5 <- c("Фактический курс ЦБ"="black", "Курс плана" = "darkgreen")
p9<-qplot(y=rates$факт, size=I(3), colour = "Фактический курс ЦБ")+geom_line(size=1)+geom_line(aes(y=rates$план, colour="Курс плана"), size=1)+scale_x_discrete(breaks=1:35)+theme_bw() + theme(legend.position="top") +
        xlab("Номер месяца с начала 2013 года") + ylab("Курс доллара")+ scale_color_manual(name="", values = cols5) +
        geom_line(aes(y=rates[,4]), alpha=0.2) +
        geom_line(aes(y=rates[,5]), alpha=0.25) +
        geom_line(aes(y=rates[,6]), alpha=0.3) +
        geom_line(aes(y=rates[,7]), alpha=0.35) +
        geom_line(aes(y=rates[,8]), alpha=0.4) +
        geom_line(aes(y=rates[,9]), alpha=0.5) +
        geom_line(aes(y=rates[,10]), alpha=0.55) +
        geom_line(aes(y=rates[,11]), alpha=0.6) +
        geom_line(aes(y=rates[,12]), alpha=0.65) +
        geom_line(aes(y=rates[,13]), alpha=0.7) +
        geom_line(aes(y=rates[,14]), alpha=0.75) +
        geom_line(aes(y=rates[,15]), alpha=0.8) +
        geom_line(aes(y=rates[,16]), alpha=0.85) +
        geom_line(aes(y=rates[,17]), alpha=0.9) +
        geom_line(aes(y=rates[,18]), alpha=0.95)
 
       
cols4 <- c("Ошибка курсов ЦБ"="black", "Ошибка курсов плана" = "darkgreen")
p8 <- ggplot()+geom_point(aes(x=1:15, y=tail(mae,15), colour = "Ошибка курсов ЦБ"), size=4)+
        geom_line(aes(x=1:15, y=tail(mae,15)), size=0.5)+
        geom_point(aes(y=head(mae,1), x=1, colour="Ошибка курсов плана"), size=4)+
        scale_color_manual(name="", values = cols4)+theme(legend.position="top")+
        scale_x_discrete(breaks=1:15)+ ylab("Средняя абсолютная ошибка") + xlab("День установления планового курса")
 
p9
 
#rates <- data.frame(month = seq(as.Date("2013-01-01"), as.Date("2015-11-01"), by = "month"))
#rates$month <- format(rates$month, "%b.%y")
#rates$fact <- c()
```
 
Рассчитаем среднюю абсолютную ошибку как среднее значения отклонения (без знака) от фактического курса. На графике ниже изображено как уменьшается средняя ошибка с установлением курса все все ближе и ближе к планируемому месяцу. Зеленая точка - средняя ошибка плановых курсов, установленных внутри компании.
 
```{r plot errors}
p8
 
```
 
Можно увидеть, что "наивный" способ планирования в среднем дает не такие плохие результаты относительно экспертного способа. Как уже говорилось, так простой способ планирования можно использовать как бенчмарк других более сложных моделей. Использовать более сложные модели имеет смысл если они дают меньшую среднюю ошибку.
 
Мне кажется - это хорошая иллюстрация того, что в общем, довольно сложно предположить что-то о том, каким будет курс доллара, кроме того, что он будет в какой-то степени похож на сегодняшний.
 
Вообще говоря, судя по всему, именно этой методикой планирования пользуется ЦБ РФ когда устанавливает курс официаьный курс "на завтра" по сути фиксируя сегодняшний курс в 11:30.
 
*****
```{r rate table}
kable(rates, digits=2, caption = "Таблица 1. Курсы USD/RUB среднемесячные фактические, плановые - установленные внутри компании, курсы ЦБ на даты предыдущего месяца. Фактические курсы ограничены двумя знаками после запятой, в расчетах использовалось 4 знака.")
kable(ratesErrors, digits=2, caption = "Таблица 2. Отклонения плановых и курсов ЦБ от фактических среднемесячных. Фактические курсы ограничены двумя знаками после запятой, в расчетах использовалось 4 знака.")
```
 
 
[^1]: Но, кстати, часто, в экономическом прогнозировании, когда мы не можем обоснованно судить о будущих значениях определяющих переменных, а так же о возможных изменениях в характере зависимости, такой способ прогнозирования показателей: просто взять последнее на сегодня значение - дает не такие плохие результаты. Такой способ прогнозирования называют [Naive method](https://en.wikipedia.org/wiki/Forecasting#Na.C3.AFve_approach). Его удобно использовать как , относительно которого можно оценивать результаты более сложных способов прогнозирования.
 
[^2]: Модель: линейная регрессия. Y = b'*log(X). в которой цена нефти  - предиктор, а курс доллара - зависимая переменная. Цена нефти подвергнута логарифмической трансформации: предварительное моделирование показало, что экспоненциальная зависимость дает чуть более точные результаты чем линейная.
 
[^3]: В данном случае он так же равен квадрату корреляции логарифма цены на нефть и курса доллара.
 
[^usd]: Данные Yahoo: https://beta.finance.yahoo.com/quote/USDRUB%3DX/news
 
[^oil]: Данные The Federal Reserve Bank of St. Louis: https://research.stlouisfed.org/fred2/series/DCOILBRENTEU
 
[^interventions]: Данные ЦБ РФ: http://www.cbr.ru/hd_base/default.aspx?prtid=valint_day&pid=idkp_br&sid=ITM_45393
 
[^smallmoves]: Это не более чем предположение, изменение политики ЦБ совпало с сильнейшим движением цены нефти, и пока не было ситуации "продолжительных незначительных колебаний". Может быть рынок, со временем, перестанет на них остро реагировать и без валютного коридора. Так же следует учитывать, что интервенции продолжались и после отмены валютного коридора, что можно увидеть на графике.
 
[^noimpact]: Скорее всего, здесь уже не идет речи о какой-либо зависимости, а просто о совпадении направлений движения связанном с воздействием различных факторов.
 
[^linearTrend]: Линейная регрессия на данных соответствующих календарному году: Y = b'*X. По некоторым годам, например по 2014, хорошо видно почему для общей модели мной была выбрана логарифмическая трансформация цены на нефть: соотношение курса и цены имеет немного вогнутый характер. Экспоненциальное приближение было выбрано также исходя из представления о том каким может быть курс доллара в предельном случае падения цены на нефть до нуля.
 
[^modelError]: Например вследствие выбора слишком большого количества исторических данных наша модель будет учитывать уже не актуальные зависимости, что будет смещать делать ее неточной. Ошибка модели в свою очередь как было отмечено ранее состоит из ошибки вследствие систематического смещения оценки (bias) и ошибки вследствие малого количества данных(variance).
 
[^money]: Даже если у этого агента будет недостаточно собственных финансовых ресурсов для существенного воздействия на рынок, сегодня имеется достаточно широкий доступ к заемным ресурсам в виде кредитов и финансовых плеч. Все это позволило бы довольно быстро увеличить капитал до размеров достаточных для влияния на рынки. Если и этого будет недостаточно, скорее всего, другие участники рынка со временем обнаружат этот замечательный способ прогноза, или, как минимум, обратят на стабильно успешные действия первого агента и будут следовать им.
 
[^inflation]: Это безусловно лишь предположение и подлежит дополнительному изучению.
 
[^interval]: Имеется ввиду интервал "предсказаний". На самом деле, учитывая что остатки модели имеют не совсем нормальное распределение, строго говоря, мы не можем утверждать что это именно 95% интервал. Помимо этого, учитывая, потенциальные изменений в характере зависимости со временем, даже этот не точный интервал корректно рассматривать в контексте лишь следующего дня, а не всего 2016 года как изображено на графике. Конечно, этот интервал должен увеличиваться с течением времени.